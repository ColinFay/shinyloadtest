---
title: "Load Test Results"
output: 
  html_document: default
  html_notebook: default
params: 
  url:
    label: "Deployed URL"
    value: "https://beta.rstudioconnect.com/content/2551/"
  concurrent:
    label: "Number of Concurrent Connections"
    value: 4
  total: 
    label: "Total Number of Connections"
    value: 4
  testFile:
    label: "Path to Load Test Script"
    value: '../examples/example_loadTest_superzip.R'
  stagger: 
    label: "Maximum Delay in Staggering Concurrent Connections (sec)"
    value: 5
  loadTimeout:
    label: "Maximum time to wait for the Shiny app to load (sec)"
    value: 15
  phantomTimeout:
    label: "Maximum time to wait for phantomJS to start (sec)"
    value: 30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
source("analyzeLog.R")
library(shinyloadtest)
library(ggplot2)
library(dplyr)
```

Load test run against `r params$url`. The load test target was **`r params$total` total visits** with **`r params$concurrent` concurrent users** at a time. Concurrent user sessions were staggered, with a max delay of `r params$stagger` seconds. Each "user" ran a series of actions against the application as recorded in `r params$testFile`.

```{r runTest, warning = FALSE}
loadTestLog <- loadTest(testFile = params$testFile, 
                        url = params$url,
                        numConcurrent = params$concurrent,
                        numTotal = params$total, 
                        loadTimeout = params$loadTimeout,
                        stagger = params$stagger,
                        phantomTimeout = params$phantomTimeout)
```

A baseline test was run with **`r min(params$total,10)` total visits** occuring sequentially, one at a time.

```{r}
baselineLog <- loadTest(testFile = params$testFile, 
                        url = params$url,
                        numConcurrent = 1,
                        loadTimeout = params$loadTimeout,
                        numTotal = min(params$total,10), 
                        stagger = 0)
```


## Results

```{r}
if (!is.data.frame(loadTestLog)) {
  errors <- getErrors(loadTestLog)
  loadTestLog <- getSuccesses(loadTestLog)
}
```


Of the targetted `r params$total` visits, `r length(unique(loadTestLog$connection))` were successful. 

```{r}
if (exists("errors")) {
  print("The following errors occured in the unsuccessful visits:")
  print(errors)
}
```

A maximum `r getMaxConcurrent(loadTestLog)` concurrent connections were achieved, compared to the target of `r params$concurrent`.

`r if ( !exists("errors") && (getMaxConcurrent(loadTestLog) < params$concurrent)) {message("Because all visits were successful, but the number of concurrent connections did not meet the target, consider lowering the stagger parameter or checking the server settings.")}`


## Comparison to Baseline

```{r}
load <- getPageLoadTime(loadTestLog) %>% 
  mutate(type = "Under Load")
base <- getPageLoadTime(baselineLog) %>% 
  mutate(type = "Baseline")

results <- rbind(load, base)

ggplot(results, aes(loadTime_s, fill = type)) + 
  geom_density(alpha = 0.4) +
  theme_minimal() +
  labs(
    title = "Page Load Time",
    subtitle = paste(params$concurrent, "Concurrent Targetted"),
    x = "Load Time (sec)",
    y = "", 
    fill = ""
  )
```

The average page load time under load was `r mean(load$loadTime_s)` seconds compared to `r mean(base$loadTime_s)` seconds with no concurrent load.

The following graph shows the response time for specific events taken after page load.

```{r}
load <- getSetInputTime(loadTestLog)
base <- getSetInputTime(baselineLog)

load$type = "Under Load"
base$type = "Basline"

results <- rbind(load, base)

ggplot(results, aes(time_s, fill =  type)) +
  geom_density(alpha = 0.4)  +
  facet_wrap(~input, scales = "free") +
  labs(
    title = "Application Usage",
    y = "",
    x = "Event Time (sec)",
    fill = ""
  ) +
  theme_minimal()
```

